(ns hemmvm.clj-workshop.brainfuck.test.machine-test
  (:require [clojure.test :refer [deftest is are]]
            [hemmvm.clj-workshop.brainfuck.machine :as m]))


(deftest test-new-machine
  (is (= {:ip 0 :mp 0 :mem {}}
         (m/new-machine))))

(deftest test-run
  (are [machine insts] (= machine
                          (m/run (m/new-machine) insts))

    {:ip 9 :mp 0 :mem {0 3 1 2}}
    ["+" "+" "+" "+" ">" "+" "+" "<" "-"]

    {:ip 5 :mp 0 :mem {0 0 1 8}}
    ["+" "+" "+" "+" [">" "+" "+" "<" "-"]]

    {:ip 5 :mp 0 :mem {0 0 1 8}}
    ["+" "+" "+" "+" [">" "+" "+" "<" "-"]]

    {:ip 10 :mp 0 :mem {0 0 1 0 2 72 3 104 4 88 5 32 6 8}}
    [["," "."
      ["."]
      "," "." "." "," "," "," "+" "," "-" "," "<" ">" ","
      []
      "." "."]
     "+" "+" "+" "+" "+" "+" "+" "+"
     [">" "+" "+" "+" "+"
      [">" "+" "+" ">" "+" "+" "+" ">" "+" "+" "+" ">" "+" "<" "<" "<" "<" "-"]
      ">" "+" ">" "+" ">" "-" ">" ">" "+"
      ["<"]
      "<" "-"]])


  (is (= "Hello World!\n"
         (->> [["," "."
                ["."]
                "," "." "." "," "," "," "+" "," "-" "," "<" ">" ","
                []
                "." "."]
               "+" "+" "+" "+" "+" "+" "+" "+"
               [">" "+" "+" "+" "+"
                [">" "+" "+" ">" "+" "+" "+" ">" "+" "+" "+" ">" "+" "<" "<" "<" "<" "-"]
                ">" "+" ">" "+" ">" "-" ">" ">" "+"
                ["<"]
                "<" "-"]
               ">" ">" "." ">" "-" "-" "-" "." "+" "+" "+" "+" "+" "+" "+" "." "." "+" "+" "+"
               "." ">" ">" "." "<" "-" "." "<" "." "+" "+" "+" "." "-" "-" "-" "-" "-" "-" "."
               "-" "-" "-" "-" "-" "-" "-" "-" "." ">" ">" "+" "." ">" "+" "+" "."]
              (m/run (m/new-machine))
              with-out-str))))
